Atitit 余额扣钱逻辑正确性对乐观锁模式



乐观锁的方案呢？
对并发扣款进行进一步的分析发现：
（1）业务 1 写回时，旧余额 100，这是一个初始状态；新余额 28，这是一个结束状态。理论上只有在旧余额为 100 时，新余额才应该写回成功。
而业务 1 并发写回时，旧余额确实是 100，理应写回成功。
（2）业务 2 写回时，旧余额 100，这是一个初始状态；新余额 28，这是一个结束状态。理论上只有在旧余额为 100 时，新余额才应该写回成功。
可实际上，这个时候数据库中的金额已经变为 28 了，所以业务 2 的并发写回，不应该成功。
如何低成本实施乐观锁？
在 set 写回的时候，加上初始状态的条件 compare，只有初始状态不变时，才允许 set 写回成功，Compare And Set（CAS），是一种常见的降低读写锁冲突，保证数据一致性的方法。
此时业务要怎么改？
使用 CAS 解决高并发时数据一致性问题，只需要在进行 set 操作时，compare 初始值，如果初始值变换，不允许 set 成功。
具体到这个 case，只需要将：
UPDATE t_yue SET money=newmoneyWHEREuid=new_money WHERE uid=newm​oneyWHEREuid=uid;
升级为：
UPDATE t_yue SET money=newmoneyWHEREuid=new_money WHERE uid=newm​oneyWHEREuid=uid AND money=$old_money_;__
即可。
_
并发操作发生时：
业务 1 执行：
UPDATE t_yue SET money=28 WHERE uid=$uid AND money=100;
业务 2 执行：
UPDATE t_yue SET money=38 WHERE uid=$uid AND money=100;
这两个操作同时进行时，只可能有一个执行成功。
怎么判断哪个并发执行成功，哪个并发执行失败呢？
set 操作，其实无所谓成功或者失败，业务能通过 affect rows 来判断：

写回成功的，affect rows 为 1


写回失败的，affect rows 为 0

总结
高并发 “查询并修改” 的场景，可以用 CAS（Compare and Set）的方式解决数据一致性问题。对应到业务，即在 set 的时候，加上初始条件的比对即可。
优化不难，只改了半行 SQL，但确实能解决问题。
但希望大家有收获**，思路比结论重要**。
作业，为什么不能使用：
UPDATE t_yue SET money=money-$diff;
关注下面的标签，发现更多相似文章

数据库

SQL



58沈剑_架构师之路 架构师 @ 58
发布了 67 篇专栏 · 获得点赞 1,626 · 获得阅读 131,696 
关注

安装掘金浏览器插件 
打开新标签页发现好内容，掘金、GitHub、Dribbble、ProductHunt 等站点内容轻松获取。快来安装掘金浏览器插件获取高质量内容吧！



技术笔记与开源分享 
业余爱好者
作业：不是幂等的了。万一有重试的情况，重复扣款
3小时前
 · 删除
回复


工控猫
UPDATE t_yue SET money=money-$diff 不能判断余额是否够减，导致余额可能出现负数
9小时前
 · 删除
回复

香草是你的名字 
JAVA开发
表中添加版本号字段呢
11小时前
 · 删除
回复

许小桀！ 
一个思路
10小时前
 · 删除
回复

ThinkMar 
万一退款了呢，当然这不符合题目假设啦，再加个更新时间条件
11小时前
 · 删除
回复

许小桀！ 
你这属于两条业务的操作，不属于单条业务的并发操作。
10小时前
 · 删除
回复

用户9235620014258 
UPDATE t_yue SET money=money-$diff where uid = $uid and money >= $diff
23小时前
 · 删除
1
回复

叶英豪 
Java开发工程师
这会多买的 会被骂死
21小时前
 · 删除
回复

叶英豪 
Java开发工程师
只要钱足够多 一个人就包完了
21小时前
 · 删除
回复

醉逍遥子 
可以 学习了
1天前
 · 删除
回复

想要一个帅气的昵称 
学习了，原来有这么简单的方式
1天前
 · 删除
回复

勤任风 
全栈工程师
学习了
1天前
 · 删除
回复
相关推荐


58沈剑_架构师之路 

1天前
数据库 Java 
并发扣款一致性，幂等性问题，这个话题还没聊完！！！ 
16 
6 

微博 

微信扫一扫 





_灯火阑珊处 

8小时前
SQL 
SQL语句优化 
2 
2 

微博 

微信扫一扫 





敖丙 

3天前
Java 数据库 
innodb是如何一步步插入一条数据的 
63 
4 

微博 

微信扫一扫 





58沈剑_架构师之路 

1天前
数据库 Java 
并发扣款一致性优化，CAS下ABA问题，这个话题还没聊完！！！ 
7 


微博 

微信扫一扫 





tpolong 

1天前
数据库 
ClickHouse H3缓冲区查询 
1 


微博 

微信扫一扫 





华为云开发者社区 

9小时前
数据库 
数据库运维家中常备：上限约400MB/s，比COPY等工具还好用的数据利器 
1 


微博 

微信扫一扫 





PingCAP 

1天前
数据库 
TiDB 5.0 RC Release Notes 



微博 

微信扫一扫 





敖丙 

18天前
Java 数据库 
为什么MySQL不建议delete删除数据 
108 
21 

微博 

微信扫一扫 





DolphinDB 

1天前
数据库 
干货丨时序数据库DolphinDB API性能基准测试报告 



微博 

微信扫一扫 



关于作者

58沈剑_架构师之路 
架构师 @ 58

获得点赞1,626
文章被阅读131,696




相关文章

缓冲池(buffer pool)，这次彻底懂了！！！
161
19

数据库允许空值 (null)，往往是悲剧的开始（1 分钟系列）
107
35

炸！业界难题，跨库分页的几种常见方案
127
16

群聊比单聊，为什么复杂这么多？
118
14

互联网公司为啥都不用MySQL分区表？
40
10

目录
分享

掘金浏览器插件

作者：58沈剑_架构师之路
链接：https://juejin.cn/post/6920098218634133517
来源：掘金
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

